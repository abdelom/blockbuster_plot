# Blockbuster

## Overview

Blokbuster is a software tool designed to infer past population size changes based on Site Frequency Spectrum (SFS) data. It combines a C program (`blockbuster_main.c`) that processes the SFS and a Python script that visualizes and analyzes the results.

## Requirements

### Dependencies

To run this software, you'll need the following dependencies:

Python:
- Python 3.8 or newer
- NumPy
- Matplotlib
- demes
- demesdraw

### Installation

You can install the required dependencies by creating a Conda environment. The following steps will guide you through setting up the environment and running the code.
You only need the Conda environment to generate graphical outputs. 

1. Create the Conda Environment

To create the environment, download or copy the `environment.yml` file, and run:

conda env create -f environment.yml

This will create a Conda environment called `blockbuster_env` with all the necessary dependencies installed.

2. Activate the Conda Environment

After the environment is created, activate it with:

conda activate blockbuster_env

4. Format the entry file

The input file must contain the SFS on a single line. If the SFS is folded, it needs to be completed with zeros so that there are exactly n – 1 bins in the SFS (see example_sfs.blk and folded_example_sfs.blk).

5. Running the Programs

a. Using Bash Script

A bash script is provided to simplify the execution of the software. You can run it as follows:

bash blockbuster.sh --sfs <path_to_sfs_file> --prefixe_directory <output_directory> [options]

You can choose to run the C program (for inference) and the Python script (for plotting) separately as follows:

b. Running the C Program (`blockbuster_main`)

./bin/blockbuster_main -p <output_directory> -s <sfs_file> 

- `-p` (required): Prefix directory where the output will be stored.
- `-s` (required): The Site Frequency Spectrum (SFS) file.
- `-b`, --blocks: Number of blocks to divide the SFS for training and test sets (default: 1, training set and test set are the same). Not recommended.
- `-u`, --upper_bound: Upper bound for the time grid in units of Ne generations (default: 2). It is not recommended to modify this value.
- `-l`, --lower_bound: Lower bound for the time grid in Ne generations (default: 1e-4). "(This value has to be not too small, before 1 / haploid sample size)
- `-e`, --epochs: Maximum number of epochs, models from 1 to e epochs will be infered (default: 5). 
- `-o`, --oriented: Oriented flag. it has to be set to 0 if the SFS is folded (default: 1).
- `-t`, --truncation: Truncation value. If set to n, the inference is performed over the first n SFS bins; the remaining bins are ignored.
- `-S`, --singleton: Whether to consider singletons (default: 1). If set to 1, the singleton bin is included; if set to 0, it is excluded.
- `-L`: --genome_length (default: -1). Genome length. Required together with the mutation rate (-m) to convert sizes into effective population sizes (Ne) and times into generations. If not provided, sizes and times are expressed in units of θ (4NeμL) and Ne generations.
- `-m`: --mutation_rate (default: -1). Mutation rate per site per generation (default: -1). Required together with the genome length (-L) to express sizes in Ne and times in generations. If not provided, results remain in units of θ and Ne generations.
- `-g`: --generation_time in years (default: -1). Generation time in years (default: -1). When provided with genome length (-L) and mutation rate (-m), times are additionally expressed in years.

Note: No special environment is required to run this program, as the executable is already provided in the repository under the `bin` folder.

c. Running the Python Script

After running the C program, you can analyze and visualize the output using the Python script.
To do so, install the conda environnement as explain in 1) and run:

python parsandplot.py -i <input_file> -o <output_directory>

- `-i` (required): The input file generated by the C program (`scenarios.txt`).
- `-o` (required): Directory to save the plot.
- `-g`: Generation time.

The script uses **demesdraw** to plot the demographic models inferred from the results.

6. Output

The main output is the file prefix/scenarios.txt.
This file is parsed by the Python script to generate plots in the output directory.

## License

This software is open-source and released under the MIT license.

## Contact

For issues or questions, feel free to open an issue on the GitHub repository or contact the maintainers. abdelmajid.omarjee@mnhn.fr
